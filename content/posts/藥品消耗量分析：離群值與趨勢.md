+++
title = '藥品消耗量分析：離群與趨勢'
slug = 'consumption-oulier-tendency-alert'
date = 2023-09-25T07:45:15+08:00
draft = true
isCJKLanguage = true
showToc = true
TocOpen = true
categories = ['資料視覺化']
math = true
tags = []
+++
之前利用了 python 固定每週彙整出所有藥品的各週消耗量，接著就可以計算每個藥品消耗量的**指標值**，訂出適當的閾值，篩選出指標超過閾值的藥品，形成警示列表。
![Alert-Data-Like](/images/2023-10-alert-data-like.png#center)
***
## 離群值

### 離群值是什麼？
統計上的離群值 (outliers) 指的是超出其類型預期常態的極端數據點，因為各種因素導致的異常數值，例如：輸入錯誤、惡意新增數據、系統異常等等，會嚴重影響統計量的估計值和指標，造成偏差。一般而言，離群值相較於母體或樣本大部分是少數特例，排除後統計量才會比較接近母體或樣本的常態。

在藥品消耗量上，因為消耗量是已經發生過的事實，所以離群值的出現並不是錯誤值，不需要額外排除，反而需要去詳細檢視原因，並且調整往後訂購藥品的計畫。所以針對離群值，反而需要偵測並篩選出來而非排除。

### 偵測離群值
離群值的偵測方法有好幾種，傳統數學的 3 倍標準差法 ( Z 分數法)、箱型圖法，機器學習的 DBSCAN 、 Isolation Forest ，另外對於深度學習也有提出 GANs 等方法來檢測離群值，並且已經成熟到可以應用於產品上，例如心跳離群值的檢測以早期發現疾病等[^1]。

[^1]: [Deep Learning for Anomaly Detection.](https://ff12.fastforwardlabs.com/)

我們需要的是要快速計算出近 1,500 種藥品各 52 週的離群值，由於機器學習或是深度學習都需要先以已經有的資料訓練個別資料的模型，或者是經過一些時間的非監督式學習，才能正式使用在資料上。以現有的需求，機器學習或是深度學習是耗時並且浪費的，所以以傳統數學的方法來檢測藥品消耗量的離群值，並且直接假設所有的消耗量分布都**屬於常態分佈**。

箱型圖法 (Boxplots) 是計算出資料的各四分位數資料後，計算第三四分位數 (Q3) 和第一四分數 (Q1) 的差 (四分位距 IQR) ，如果資料點在臨界四分位數 (Q3 或 Q1) 外 **1.5** 倍的 IQR ，該資料點就是離群值。

例如，假設有一筆資料 `[0, 1, 2, 3, 10, 20, 30, 600, 9000]`，各統計量如下：

![Boxplot Sample](/images/2023-10-boxplot-sample.png#center)

- Q1 = (1+2)/2 = 1.5
- Q2 = 10
- Q3 = (30+600)/2 = 315
- 四分位距 IQR = 315-1.5 = 313.5
- 下限 = 1.5-1.5×313.5 = -468.75
- 上限 = 315+1.5×313.5 = 785.25

也就是說， 9000 這筆資料已經超過了上限 785.25 ，視為該筆資料的離群值。

然而四份位數對於資料波動的變化程度影響有限，後來改用標準差法來進行計算。也就是當資料屬於常態分佈時，資料分布在平均數正負三個標準差內的機率應該為 99.7% ，換句話說，在三個標準差外的可以視為離群值。

![deviation](https://homepage.ntu.edu.tw/~clhsieh/biostatistic/images/deviation.png#center)

一樣的例子，資料 `[0, 1, 2, 3, 10, 20, 30, 600, 9000]`，各統計量如下：
- 平均值 = 1074
- 母體標準差 = 2808.32
- 下限 = 1074-3×2808.32 = -7350.96
- 上限 = 1074+3×2808.32 = 9498.96

該筆資料全部都落在 -7350.96 到 9498.96 之間，沒有離群值。與箱型圖法就產生了差異。

### 程式實作
實際計算藥品的消耗量後，發現 3 倍的標準差以外視為離群值的資料量還是過大，微調之後改採用 4 倍標準差。而且資料區間取一年的每週消耗量，無法很準確的代表最近這幾週的資料，也是經過微調後，僅取後 12 個資料點。但為了避免後續需要再次調整，所以先把閾值變數拉到程式最上面。
```python
import pandas as pd
import numpy as np
# 閾值變數
data_range = 12 # 只取最近的 12 個資料點就好
std_times = 4 # 4 倍標準差以外的視為離群值
```
引入檔案後，整理資料表頭：
```python
# 引入上次的中繼檔案
df = pd.read_csv('暫存.csv')
df = df.iloc[:,-data_range:]
# 原始檔案的 column name 都是日期，重新換成固定的名字 data_x 比較好操作
header = [f'data_{x}' for x in range(0, data_range)]
df = df.set_index('藥品代碼')
df.columns = header
```
排除12個資料都是0的品項，分析沒有意義，也不需要列出警訊：
```python
df = df.loc[df.sum(axis=1)!=0]
```
計算第 1 個到第 11 個的統計值， `.mean()` 和 `.std()` 的預設值都是 `axis=0` 計算直欄的結果，所以要代入 `axis=1` ，而 `.std()` 預設的自由度 `ddof` 是 1 ，也要改成 0 ，因為資料屬於母體總數，而不是抽樣樣本數。
```python
# ppl = population
ppl = [f'data_{x}' for x in range(0, data_range-1)]
df['ppl_mean'] = df[ppl].mean(axis=1)
df['ppl_std'] = df[ppl].std(axis=1, ddof=0)

# 計算上下限
df['upper_std_times'] = df['ppl_mean'] + std_times * df['ppl_std']
df['lower_std_times'] = df['ppl_mean'] - std_times * df['ppl_std']
```
列出大於或小於限制的藥品，並且加入排序依據後輸出 csv 檔：
```python
df.loc[df[f'data_{data_range-1}']>df['upper_std_times'], 'outlier'] = 'greater'
df.loc[df[f'data_{data_range-1}']<df['lower_std_times'], 'outlier'] = 'less'
df['outlier_rate'] = (df[f'data_{data_range-1}']-df['ppl_mean']) / df['ppl_std']
df['outlier_rate'] = df['outlier_rate'].abs().replace(np.inf,np.nan)

df = df.loc[df['outlier'].notna()]
df = df.sort_values(by=['outlier_rate','code'])

df.to_csv('outliers.csv')
```
這個檔案接下來就交給 php 讀取再丟入 chartjs 製圖。
***
## 顯著趨勢
### 簡單線性回歸
### R squared 和 *p*-value
<!--R方看这条直线拟合得好不好，p值判断这条直线是否存在。-->
### 回歸線與 x 軸的夾角
### 程式實作
***
## 圖表設計
### 離群值
### 顯著趨勢
***
## 成果

