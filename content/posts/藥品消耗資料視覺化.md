+++
title = '藥品消耗資料視覺化'
slug = 'Medicine-Consumption-Data-Visualization'
date = 2023-09-04T16:13:53+08:00
draft = true
isCJKLanguage = true
showToc = true
TocOpen = true
categories = ['藥品消耗']
tags = ['Python','MySQL','Database','Chartjs','PyAutoGUI','PHP','MariaDB']
+++
身為藥品庫存管理的藥師，最重要的事情就是確保藥品的供應無虞，因此對於某個藥品的消耗情形必須具備數據敏感性，當發生異常波動才能有辦法立刻做出應對。

隨著大數據的時代來臨，在 2016 年就有人提出資料視覺化 (Data Visualization) 的概念，以好懂的圖表呈現數字，可以直覺的方式快速掌握資料特性。

受惠於資料視覺化的概念，雖然單個醫院的藥品消耗數量沒有達到大數據級的規格，但是資料視覺化的應用可以增加藥師對於藥品的數據敏感性，藥師不需要仰賴經驗。
***
## 資料收集
### pyautogui
醫院藥師不是資訊室人員，對於醫師在何時幫哪個病人開了哪個藥的資訊，因為涉及到病人安全與個資法規範，只能從資訊室提供的程式實時查詢匯出檔案，再利用 Excel 等程式將資料另做分析。

即時的需求，當然可以直接操作系統。但如果要**自動化**製作每天的圖表，勢必得使用自動操作的方式，並且在**非上班**的時段把檔案匯出（向資訊室查詢大筆資料其實滿耗時）。

為了不驚擾資訊室工程師，此時就利用 Python 自動操控滑鼠鍵盤的 Package [`PyAutoGUI`](https://pypi.org/project/PyAutoGUI/) ：
```bash
pip install pyautogui 
```

程式的部分，使用以下幾個語法互相搭配，模擬手動操作院內程式：
```python
#先引用套件或模組進來
import datetime #日期時間
import os
import time
import pyautogui

os.system('TASKKILL /F /IM <院內程式名稱>.exe 1>NUL 2>NUL') #強迫關閉當掉的院內程式
time.sleep(10) #暫停執行10秒鐘
os.popen('<院內程式名稱>.exe') #執行院內程式，這邊要使用絕對路徑比較保險
time.sleep(1.5) #執行院內程式時，緩衝執行1.5秒鐘

pyautogui.click((x,y)) #滑鼠點擊螢幕的 x 座標和 y 座標
pyautogui.click((x,y), clicks=2) #滑鼠點兩次

pyautogui.write('文字', interval=0.01) #以 0.01 秒的間隔輸入文字，不能是中文

pyautogui.press('enter') #按下 Enter 鍵
pyautogui.press('shift') #按下 Shift 鍵，通常用來切換中英輸入法
pyautogui.hotkey('alt', 'f4') #同時按下 Alt 和 F4 鍵來關閉現在的視窗
```

定位每個操作的滑鼠座標是撰寫這個程式的大工程，可以用以下的 python 程式來記錄：
```python
import pyautogui
while True:
    if pyautogui.position() == (0, 0):
        quit()
    prev_position = pyautogui.position()
    if pyautogui.position() != prev_position:
        print(pyautogui.position())
```
或者網路上有其他現成的小工具也可以輔助，例如 [AutoHotkey](https://www.autohotkey.com/) 等等。

院內程式匯出的檔案格式有限，過去藥師們會使用 xls 檔案以利於後續的編輯操作。現在需要產生的報表為了繪圖的關係，通常都會超過 65536 列 (rows；橫的；中國稱行)，所以只能存成文字檔，例如 csv ，避免資料流失或是院內程式存不起來。

### 批次執行檔 Batch
把以上的 python 檔案存成 py 檔之後，因為涉及到模擬滑鼠跟鍵盤的操作，所以執行的時候必須取得系統管理者權限，以此越過 User Access Control (UAC) prompt。
![Run as Administrator](/images/2023-09-run-as.png#center)
而執行程式時，我並不在電腦前面無法手動變更環境，因此我後來多寫了一個 Batch 檔，取得權限後再執行 python ，以下是網路找到取得權限的寫法。
```batch
@echo off
>nul 2>&1 "%SYSTEMROOT%\system32\cacls.exe" "%SYSTEMROOT%\system32\config\system"
if '%errorlevel%' NEQ '0' ( goto UACPrompt ) else ( goto gotAdmin )
:UACPrompt
    echo Set UAC = CreateObject^("Shell.Application"^) > "%temp%\getadmin.vbs"
    echo UAC.ShellExecute "%~s0", "", "", "runas", 1 >> "%temp%\getadmin.vbs"
    "%temp%\getadmin.vbs"
    exit /B
:gotAdmin
    if exist "%temp%\getadmin.vbs" ( del "%temp%\getadmin.vbs" )
    pushd "%CD%"
    CD /D "%~dp0"

python pyautogui檔案的絕對路徑.py
```
把這個檔案存成 .bat 檔，執行該程式的時候就可以用系統管理者權限來操作鍵盤滑鼠。

### 工作排程器
python 好像也可以處理定時執行程式的寫法，但是因為我不太喜歡背景卡一個自己寫的程式在執行，後來選擇的是 Windows 內建的工作排程器。

可以在 `開始 > Windows系統管理工具 > 工作排程器` 的資料夾裡面找到他，或是按下 `Win+R` 輸入 `taskschd.msc` ，~~不知道為什麼經過一陣卡卡的~~，就會看到下面這個畫面：
![Task Scheduler](/images/2023-09-Task-Scheduler.png)
點選右側選單的 `建立基本工作` 或 `建立工作` ，依序輸入希望執行時間和間隔時間：
![Create Task](/images/2023-09-create-task.png#center)
啟動程式填入剛剛形成的 Batch 檔案，便可以在指定的時間重複執行自動鍵盤滑鼠了。
***
## 資料結構化
以本院為例，依照門診藥局與住院藥局等單位區分，總共會經過四次查詢，匯出四個檔案：
![Exported files](/images/2023-09-export-files.png#center)
匯出報表的院內系統在本院為不同的工程師負責，報表各自的 header 和時間日期格式都不太一樣。因為最終目的是藥品的消耗量圖表，所以現在需要將這四張表統整一個 header 出來，並且融合在一起。如果因此遇有空值，可能就回填一個特定的字串。
>例如門診藥局會有慢箋資料，但是住院藥局並不適用，因此報表就不會有。

這樣子的工作，交給 Python 知名的資料表分析 Package [`Pandas`](https://pypi.org/project/pandas/) 最適合不過。
```bash
pip install pandas 
```
這裡我們會用到 pandas 的 DataFrame 的功能， DataFrame 就是一張表格，具有欄 (columns；直的；台灣有時稱行；中國稱列) 跟列 (rows；橫的；中國稱行；pandas有時會稱為index)。可以利用以下的語法，將已經匯出完成的 csv 讀成 DataFrame。
```python
import pandas as pd #習慣上縮寫成pd
df = pd.read_csv(檔名, encoding='utf-16le', dtype=str)
#把單一個csv抓近來，習慣上縮寫成df，院內匯出報表會有語系問題，而且也不要讓系統自動判斷字串型別

df = df[['病歷號','日期','藥品代碼','總量','慢箋次數']]
#用這個方式選擇指定的欄，不用全部的欄都拉進來

df.loc[df['慢箋次數'].isna(), '慢箋次數'] = '不適用'
#如果欄位'慢箋次數'在某筆資料中是空值，則在'慢箋次數'自己的欄位中填上'不適用'

df = df.rename(columns={'病歷號':'pt','日期':'date','藥品代碼':'drug','總量':'total','慢箋次數':'refill'})
#修該欄位名稱使各csv的欄位能夠統一

df = df.fillna('無資料')
#將預設值填入空格，如果不填東西，pandas會自動判斷為float中的NaN。

df = pd.concat([opd,ud,mbd,other], ignore_index=True)
#將修改好的各單位df，使用concat功能結合在一起
```
### pd.concat
幾個比較常用的參數如底下程式碼，剩下的可以參考[官方指引](https://pandas.pydata.org/docs/reference/api/pandas.concat.html)：
```python
df = pd.concat(
    [list of DataFrames],
    axis = 0,
    ignore_index = False,    
    join = 'outer'
)
```
1. **axis = 0** 指的是直向合併，如果要橫向合併則為 1 。
2. **ignore_index = False** 表示合併之後的新 DataFrame index 需要保留原本各自的樣子，如果設定為 True ，則從首列依序標上 1、2、3...。
3. **join = 'outer'** 看下列的圖片說明。
![DataFrame Concat](/images/2023-09-df-concat.png#center)
![DataFrame Outer Concat](/images/2023-09-df-concat-outer.png#center)
![DataFrame Inner Concat](/images/2023-09-df-concat-inner.png#center)
我習慣上會將兩個表格的 columns headers 整理到一樣才會 concat ， join 的機會其實不多。
真的需要 join 的時候，我會使用 pandas 的 merge 方法，比 concat 還更好用。
***
## 資料庫管理與資料分割
另外一個麻煩的困難點是，已經發生的病人藥品消耗量**並不是定值**，醫師可以隨時修改自己前段時間的處方等情形，因此前段時間的消耗量會隨著各種原因產生變化。

所以在資料匯出時，無法只抓昨天一天的報表，必須往前抓至少一個月的資料並且覆蓋昨天匯出的報表。總資料也必須保留至少一年份的時間，才有利於視覺化後出現可觀察的趨勢和波動。以 2023 年 9 月為例，平均每日會有 61 萬筆資料複寫，總資料至少 685 萬筆。

面對如此龐大的資料，早期的我使用了免費的關聯式資料庫 MySQL ( 現在使用 MariaDB ) 來管理資料。並且以藥品名稱的第一個英文字母來進行資料分割，共分割成 27 張 data tables (包含其他非英文開頭的藥品)。

剛剛 python 的 DataFrame 可以利用下面的方式分割後存入資料表中：
```python
```